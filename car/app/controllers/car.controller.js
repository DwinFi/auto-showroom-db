const db = require("../models");
const Car = db.cars;
const Op = db.Sequelize.Op;

// –°–æ–∑–¥–∞–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
exports.create = (req, res) => {
    console.log("üì• –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è:", JSON.stringify(req.body));
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞
    if (!req.body.brand || !req.body.model || !req.body.vin) {
        console.log("‚ùå –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è");
        res.status(400).send({
            message: "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º! –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è: brand, model, vin"
        });
        return;
    }

    // –°–æ–∑–¥–∞–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è
    const car = {
        vin: req.body.vin,
        brand: req.body.brand,
        model: req.body.model,
        year: req.body.year || 2024,
        color: req.body.color || "–ù–µ —É–∫–∞–∑–∞–Ω",
        condition: req.body.condition || "–ù–æ–≤—ã–π",
        purchasePrice: req.body.purchasePrice || 0,
        categoryCode: req.body.categoryCode || null  // –†–∞–∑—Ä–µ—à–∞–µ–º null
    };

    console.log("üîß –°–æ–∑–¥–∞–≤–∞–µ–º—ã–π –æ–±—ä–µ–∫—Ç –∞–≤—Ç–æ–º–æ–±–∏–ª—è:", car);

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
    Car.create(car)
        .then(data => {
            console.log("‚úÖ –ê–≤—Ç–æ–º–æ–±–∏–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω:", data.toJSON());
            res.send(data);
        })
        .catch(err => {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è:", err);
            console.error("–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:", err.message);
            console.error("–°—Ç–µ–∫ –æ—à–∏–±–∫–∏:", err.stack);
            
            res.status(500).send({
                message: "–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è: " + err.message
            });
        });
};

// –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
exports.findAll = (req, res) => {
    console.log("üì• –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π");
    
    const brand = req.query.brand;
    var condition = brand ? { brand: { [Op.like]: `%${brand}%` } } : null;

    Car.findAll({ 
        where: condition, 
        include: ["category"] 
    })
        .then(data => {
            console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ ${data.length} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π`);
            res.send(data);
        })
        .catch(err => {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π:", err);
            res.status(500).send({
                message: err.message || "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π."
            });
        });
};

// –ù–∞–π—Ç–∏ –æ–¥–∏–Ω –∞–≤—Ç–æ–º–æ–±–∏–ª—å –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É
exports.findOne = (req, res) => {
    const id = req.params.id;
    console.log(`üì• –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –ø–æ–ª—É—á–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å ID=${id}`);

    Car.findByPk(id, { 
        include: ["category"] 
    })
        .then(data => {
            if (data) {
                console.log("‚úÖ –ê–≤—Ç–æ–º–æ–±–∏–ª—å –Ω–∞–π–¥–µ–Ω:", data.toJSON());
                res.send(data);
            } else {
                console.log(`‚ùå –ê–≤—Ç–æ–º–æ–±–∏–ª—å —Å ID=${id} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
                res.status(404).send({
                    message: `–ù–µ –Ω–∞–π–¥–µ–Ω –∞–≤—Ç–æ–º–æ–±–∏–ª—å —Å id=${id}.`
                });
            }
        })
        .catch(err => {
            console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å ID=${id}:`, err);
            res.status(500).send({
                message: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å id=" + id
            });
        });
};

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è –ø–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä—É –≤ –∑–∞–ø—Ä–æ—Å–µ
exports.update = (req, res) => {
    const id = req.params.id;
    console.log(`üì• –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å ID=${id}`);
    console.log("üìù –î–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", req.body);

    Car.update(req.body, {
        where: { carCode: id }
    })
        .then(num => {
            if (num == 1) {
                console.log(`‚úÖ –ê–≤—Ç–æ–º–æ–±–∏–ª—å —Å ID=${id} —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω`);
                res.send({
                    message: "–ê–≤—Ç–æ–º–æ–±–∏–ª—å –±—ã–ª —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω."
                });
            } else {
                console.log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å —Å ID=${id}`);
                res.send({
                    message: `–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å —Å id=${id}. –í–æ–∑–º–æ–∂–Ω–æ, –∞–≤—Ç–æ–º–æ–±–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ req.body –ø—É—Å—Ç!`
                });
            }
        })
        .catch(err => {
            console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å ID=${id}:`, err);
            res.status(500).send({
                message: "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å id=" + id
            });
        });
};

// –£–¥–∞–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–º –≤ –∑–∞–ø—Ä–æ—Å–µ
exports.delete = (req, res) => {
    const id = req.params.id;
    console.log(`üì• –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å ID=${id}`);

    Car.destroy({
        where: { carCode: id }
    })
        .then(num => {
            if (num == 1) {
                console.log(`‚úÖ –ê–≤—Ç–æ–º–æ–±–∏–ª—å —Å ID=${id} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω`);
                res.send({
                    message: "–ê–≤—Ç–æ–º–æ–±–∏–ª—å –±—ã–ª —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!"
                });
            } else {
                console.log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å —Å ID=${id}`);
                res.send({
                    message: `–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å —Å id=${id}. –í–æ–∑–º–æ–∂–Ω–æ, –∞–≤—Ç–æ–º–æ–±–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω!`
                });
            }
        })
        .catch(err => {
            console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª—è —Å ID=${id}:`, err);
            res.status(500).send({
                message: "–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∞–≤—Ç–æ–º–æ–±–∏–ª—å —Å id=" + id
            });
        });
};

// –£–¥–∞–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
exports.deleteAll = (req, res) => {
    console.log("‚ö†Ô∏è –ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –í–°–ï–• –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π");

    Car.destroy({
        where: {},
        truncate: false
    })
        .then(nums => {
            console.log(`‚úÖ –£–¥–∞–ª–µ–Ω–æ ${nums} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π`);
            res.send({ 
                message: `${nums} –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –±—ã–ª–∏ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã!` 
            });
        })
        .catch(err => {
            console.error("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤—Å–µ—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π:", err);
            res.status(500).send({
                message: err.message || "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≤—Å–µ—Ö –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π."
            });
        });
};